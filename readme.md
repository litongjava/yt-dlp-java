# yt-dlp-java

**yt-dlp-java** is a Java wrapper around [yt-dlp](https://github.com/yt-dlp/yt-dlp), a popular command-line tool for downloading videos from YouTube and other sites. This project enables you to build custom download commands using a builder pattern, execute the download process (either synchronously or as a long-running process with real-time logging), and even capture output details like downloaded file names.

## Overview

The project provides:

- **Automatic Download of yt-dlp**: If the executable is not present locally, the project automatically downloads it based on your operating system.
- **Builder Pattern for Command Options**: Use the `YtDlpOptionBuilder` to easily configure parameters such as the target URL, output template, audio extraction options, and more.
- **Synchronous and Asynchronous Execution**: Execute yt-dlp commands either synchronously using `ProcessBroker` (capturing stdout) or asynchronously via `LongProcessBroker` with event listeners.
- **Real-time Logging and Event Handling**: Capture log output (including file names or progress details) from yt-dlp in real time.

## Implementation Details

### Download Management

- **Automatic Executable Download**:  
  The class `YtDlp` checks if the yt-dlp executable exists locally. If not, it downloads the appropriate version (Windows, Linux, or macOS) from GitHub.
  
- **Executable Determination**:  
  The methods `ytDlpFile()` and `ytDlpUrl()` determine the correct file name and download URL based on the system property `os.name`.

### Command Construction

- **Builder Pattern**:  
  The `YtDlpOptionBuilder` allows you to specify options in a fluent manner. For example, you can set the target URL, choose to extract audio, define the audio format (e.g., mp3), or list available formats.

- **Option Separation**:  
  The builder accumulates command tokens into a `StringBuilder` using a custom separator (two spaces) and later splits the full command string into an array of tokens for execution.

### Process Execution

- **Synchronous Execution**:  
  The `run` method uses a `ProcessBroker` to execute the command and capture all standard output after the process completes.
  
- **Long-Running Execution**:  
  The `runLong` method uses a `LongProcessBroker` to run the process asynchronously. It also logs the command being executed along with a unique task ID (generated by the `SnowflakeId` utility).  
  Real-time log output is captured through `ProcessStreamChangeEventListener` callbacks.

### Error Handling

- **Exception Propagation**:  
  In case of errors (e.g., network issues during download, process errors), exceptions are thrown or logged appropriately. This allows you to handle errors in your application code.

## Usage Instructions

Below is a sample usage demonstrating various functionalities:

```java
package com.litongjava.yt;

import com.litongjava.yt.broker.LongProcessBroker;
import com.litongjava.yt.builder.YtDlpOption;
import com.litongjava.yt.builder.YtDlpOptionBuilder;

public class Main {

  public static void main(String[] args) {
    downloadMp3();
    // listFormat();
    // test1();
    // test2();
  }

  private static void downloadMp3() {
    // Example: Download the video as audio and convert it to mp3 format
    YtDlpOption options = new YtDlpOptionBuilder()
        .url("https://www.youtube.com/watch?v=PnHMAVXpKg8")
        .audio()                   // Enable audio extraction
        .audioFormat("mp3")        // Set the output audio format to mp3
        .build();

    // Call the download audio method
    YtDlp.execute(options);
  }

  private static void listFormat() {
    String format = YtDlp.getAvailableFormats("https://www.youtube.com/watch?v=PnHMAVXpKg8");
    System.out.println("format: " + format);
  }

  private static void test2() {
    LongProcessBroker longProcessBroker = new LongProcessBroker("yt-dlp.exe", "https://www.youtube.com/watch?v=PnHMAVXpKg8");
    longProcessBroker.addProcessStreamChangeEventListener(
        // Print the changed stream output to the console
        event -> System.out.println("event.getChangedString() = " + event.getChangedString()));
    longProcessBroker.execute();
  }

  private static void test1() {
    YtDlpOptionBuilder ytDlpOptionBuilder = new YtDlpOptionBuilder();
    ytDlpOptionBuilder.url("https://www.youtube.com/watch?v=PnHMAVXpKg8")
                      .output("%(title)s.%(ext)s");
    YtDlpOption options = ytDlpOptionBuilder.build();
    YtDlp.execute(options);
  }
}
```

### Example Use Cases

- **Download Audio (mp3)**:  
  Use the `downloadMp3()` method as shown above to download and convert a YouTube video to an mp3 file.

- **List Available Formats**:  
  Call the `listFormat()` method to retrieve and print all available download formats for the video.

- **Test Long-Running Process Execution**:  
  Use the `test2()` method to execute yt-dlp in a long-running mode while logging real-time output.

- **Custom Output Template**:  
  The `test1()` method shows how to set a custom output template using the `output` method of the builder.

## License

This project is licensed under the MIT License. Feel free to use, modify, and distribute it according to the terms of the license.